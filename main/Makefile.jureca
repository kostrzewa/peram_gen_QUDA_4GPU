################################################################################
#
# Makefile to compile and link C programs with MPI subroutines
#
# Version valid for Linux machines with MPICH
#
# "make" compiles and links the specified main programs and modules,
# using the specified libraries (if any), and produces the executables
#
# "make clean" removes all files generated by "make"
#
# Dependencies on included files are automatically taken care of
#
################################################################################

all: rmxeq mkdep mkxeq
.PHONY: all

# main programs and modules to be compiled

MAIN = main

GENERAL = distillery ranlxs input_parms
MODULES = $(GENERAL)


# tmLQCD paths
TMLQCD = $(HOME)/code/tmLQCD.kost
TMLQCD_build = $(HOME)/build/jureca/tmLQCD.quda-serial
TMLQCD_modules = ${TMLQCD_build}/quda_interface.o ${TMLQCD_build}/aligned_malloc.o \
                 ${TMLQCD_build}/matrix_utils.o ${TMLQCD_build}/source_generation.o \
                 ${TMLQCD_build}/gettime.o

# search path for modules
MDIR = ./ ../random ../modules $(TMLQCD) $(TMLQCD)/include
VPATH = .:$(MDIR)

# Logging option (-mpilog or -mpitrace or -mpianim)
LOGOPTION =

LIMEPATH = $(HOME)/local/jureca/libs/lime

# additional include directories
INCPATH = ../include $(HOME)/code/eigen $(TMLQCD)/ $(MKLROOT)/include \
	$(TMLQCD)/include $(TMLQCD_build)/ $(LIMEPATH)/include/


# additional libraries
# need to link against probably all libs in $(TMLQCD)/lib/
LIBS = wrapper hmc monomial operator solver init linalg hmc xchange rational \
       io meas m lime gfortran cuda cudart quda

LIBPATH = /usr/local/lib $(TMLQCD_build)/lib/  $(LIMEPATH)/lib/ $(HOME)/code/quda-serial/lib \
          $(EBROOTCUDA)/lib64

# scheduling and optimization options
CXXFLAGS = -Wall -pedantic -O3 -std=c++0x -fopenmp -axCORE-AVX2 
CFLAGS =   -Wall -pedantic -O3 -std=c99 -DHAVE_CONFIG_H -fopenmp -axCORE-AVX2 
LDFLAGS = -lhmc -lmonomial -loperator -lsolver -linit -lmeas -llinalg -lhmc -lxchange -lrational -lio -lquda -lcudart  -Wl,--start-group /usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/mkl/lib/intel64/libmkl_intel_lp64.a /usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/mkl/lib/intel64/libmkl_core.a /usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/mkl/lib/intel64/libmkl_sequential.a -Wl,--end-group -lpthread -lm -llime   -L/usr/local/software/jureca/Stage3/software/Toolchain/intel-para/2015.07/flex/2.5.39/lib -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib64 -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib -L/usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/mkl/lib/intel64 -L/usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/lib/intel64 -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/psmpi/5.1.4-1/lib -L/usr/local/software/jureca/Stage3/software/Core/ifort/2015.3.187-GCC-bare-4.9.3/lib/intel64 -L/usr/local/software/jureca/Stage3/software/Core/ifort/2015.3.187-GCC-bare-4.9.3/lib -L/usr/local/software/jureca/Stage3/software/Core/icc/2015.3.187-GCC-bare-4.9.3/lib/intel64 -L/usr/local/software/jureca/Stage3/software/Core/icc/2015.3.187-GCC-bare-4.9.3/lib -L/usr/local/software/jureca/Stage3/software/Core/pscom/5.0.48-1/lib -L/usr/local/software/jureca/Stage3/software/Core/popt/1.16/lib -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib64 -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib -L/usr/local/software/jureca/Stage3/software/Core/gc/7.4.2/lib -L/usr/local/software/jureca/Stage3/software/Core/libatomic_ops/7.4.2/lib -L/usr/local/software/jureca/Stage3/software/Core/ncurses/5.9/lib -L/usr/local/software/jureca/Stage3/software/Core/zlib/1.2.8/lib -L/usr/local/software/jureca/Stage3/software/Core/binutils/2.25/lib -L/usr/local/software/jureca/Stage3/software/Core/ifort/2015.3.187-GCC-bare-4.9.3/composer_xe_2015.3.187/compiler/lib/intel64 -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib64/../lib64 -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib64/../lib64/ -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib/../lib64 -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib/../lib64/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib64/../lib64 -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib64/../lib64/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/../lib64 -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/../lib64/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../../lib64 -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../../lib64/ -L/lib/../lib64 -L/lib/../lib64/ -L/usr/lib/../lib64 -L/usr/lib/../lib64/ -L/usr/local/software/jureca/Stage3/software/Toolchain/intel-para/2015.07/flex/2.5.39/lib/ -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib64/ -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/CUDA/7.5.18/lib/ -L/usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/mkl/lib/intel64/ -L/usr/local/software/jureca/Stage3/software/Toolchain/ipsmpi/2015.07/imkl/11.2.3.187/lib/intel64/ -L/usr/local/software/jureca/Stage3/software/Toolchain/iccifort/2015.3.187-GCC-bare-4.9.3/psmpi/5.1.4-1/lib/ -L/usr/local/software/jureca/Stage3/software/Core/ifort/2015.3.187-GCC-bare-4.9.3/lib/intel64/ -L/usr/local/software/jureca/Stage3/software/Core/ifort/2015.3.187-GCC-bare-4.9.3/lib/ -L/usr/local/software/jureca/Stage3/software/Core/icc/2015.3.187-GCC-bare-4.9.3/lib/intel64/ -L/usr/local/software/jureca/Stage3/software/Core/icc/2015.3.187-GCC-bare-4.9.3/lib/ -L/usr/local/software/jureca/Stage3/software/Core/pscom/5.0.48-1/lib/ -L/usr/local/software/jureca/Stage3/software/Core/popt/1.16/lib/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib64/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/ -L/usr/local/software/jureca/Stage3/software/Core/gc/7.4.2/lib/ -L/usr/local/software/jureca/Stage3/software/Core/libatomic_ops/7.4.2/lib/ -L/usr/local/software/jureca/Stage3/software/Core/ncurses/5.9/lib/ -L/usr/local/software/jureca/Stage3/software/Core/zlib/1.2.8/lib/ -L/usr/local/software/jureca/Stage3/software/Core/binutils/2.25/lib/ -L/usr/local/software/jureca/Stage3/software/Core/GCC-bare/4.9.3/lib/gcc/x86_64-unknown-linux-gnu/4.9.3/../../../ -L/lib64 -L/lib/ -L/usr/lib64 -L/usr/lib -lifport -lifcore -limf -lsvml -lm -lipgo -lirc -lpthread -lirc_s -ldl -lm


#-Wl,--start-group ${MKLROOT}/lib/intel64/libmkl_intel_lp64.a ${MKLROOT}/lib/intel64/libmkl_core.a ${MKLROOT}/lib/intel64/libmkl_sequential.a -Wl,--end-group -lpthread -lm 

############################## do not change ###################################

SHELL=/bin/bash
CXX=mpicxx
CLINKER=mpicxx
CC=mpicc 

CMODULES = #start ranlxd

PGMS = $(MAIN) $(MODULES)

-include $(addsuffix .d,$(PGMS))

# rule to make dependencies
$(addsuffix .d,$(PGMS)): %.d: %.cpp Makefile
	@ $(CXX) -ansi $< -MM $(addprefix -I,$(INCPATH)) -o $@

# rule to make dependencies
$(addsuffix .d,$(CMODULES)): %.d: %.c Makefile
	@ $(CC) -ansi $< -MM $(addprefix -I,$(INCPATH)) -o $@

# rule to compile source programs
$(addsuffix .o,$(PGMS)): %.o: %.cpp Makefile
	$(CXX) $< -c $(CXXFLAGS) $(LOGOPTION) $(addprefix -I,$(INCPATH))

$(addsuffix .o,$(CMODULES)): %.o: %.c Makefile
	$(CC) -DHAVE_CONFIG_H $< -c $(CFLAGS) $(addprefix -I,$(INCPATH))

# rule to link object files
$(MAIN): %: %.o $(addsuffix .o,$(MODULES) $(CMODULES)) Makefile
	$(CLINKER) $< $(addsuffix .o,$(MODULES) $(CMODULES)) $(TMLQCD_modules) $(LDFLAGS) $(CFLAGS) $(LOGOPTION) \
        $(addprefix -L,$(LIBPATH)) $(addprefix -l,$(LIBS)) -o $@

# produce executables
mkxeq: $(MAIN)

# remove old executables
rmxeq:
	@ -rm -f $(MAIN); \
        echo "delete old executables"

# make dependencies
mkdep:  $(addsuffix .d,$(PGMS))
	@ echo "generate tables of dependencies"

# clean directory
clean:
	@ -rm -rf *.d *.o *.alog *.clog *.slog $(MAIN)
.PHONY: clean

################################################################################
